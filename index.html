<!DOCTYPE html>
<html lang="de-CH">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="stylesheet.css" />
<link rel="icon" href="favicon.png" />
<title>SVG Downloader</title>
</head>
<body>
<main>
<canvas id="preview" width="1000" height="1000">Preview of the SVG</canvas>
<div id="input">
<p id="error">Error</p>
<textarea id="code">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
<rect width="100" height="100" fill="#9fc" />
<rect x="5" y="5" width="50" height="50" rx="5" fill="#063" />
<rect x="25" y="25" width="50" height="50" rx="5" fill="#396" />
<rect x="45" y="45" width="50" height="50" rx="5" fill="#6c9" />
</svg>
</textarea>
<div>
<a id="download" download="svg_downloaded.png">Download</a>
<input id="width" type="number" min="0" placeholder="width" value="1000" />
<input id="height" type="number" min="0" placeholder="height" value="1000" />
</div>
</div>
</main>

<script>
const canvas = document.getElementById("preview");
const input = document.getElementById("code");
const width = document.getElementById("width");
const height = document.getElementById("height");
const alert = document.getElementById("error");
const downloader = document.getElementById("download");

let archive;

function drawCanvas() {
	let svg = input.value;
	let data = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
	let output = new Image();

	output.src = data;

	output.onerror = function(error) {
	console.error("An", error.message, "error occured.");
	output.src = archive;
	alert.textContent = "error";
	alert.style.display = "inherit";
	input.style.borderColor = "var(--error)";
	};

	if (archive === data) {
	alert.style.display = "none";
	input.style.borderColor = "";
	};

	const ctx = canvas.getContext("2d");
	output.onload = function() {
	ctx.reset();
	ctx.drawImage(output, 0, 0);
	archive = output.src;
	};

	renderImage();
};

function renderImage() {
downloader.style.cursor = "wait";
downloader.href = "#";
	canvas.toBlob(function(blob) {
		if (blob) {
		const imageFile = URL.createObjectURL(blob);
		downloader.href = imageFile;
		downloader.style.cursor = "revert";
	        };
	});
};

function changeDimensions() {
	canvas.width = Math.abs(width.value);
	canvas.height = Math.abs(height.value);
	drawCanvas();
};

	window.onload = drawCanvas;
	input.addEventListener("input", drawCanvas);
	width.addEventListener("input", changeDimensions);
	height.addEventListener("input", changeDimensions);
	downloader.addEventListener("mouseover", renderImage);
</script>
</body>
</html>